<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>McGill Inventory Helper</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link rel="icon" type="x-icon" href="maple_tree.jpg"> 
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.17.0-beta.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.17.0-beta.1/mapbox-gl.js"></script>
    <!-- load proj4js from CDN -->
    <!-- https://community.esri.com/t5/developers-blog/use-proj4js-alongside-the-arcgis-api-for/ba-p/892054 -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.3/proj4.js"></script>
    <!-- then load the ArcGIS API for JavaScript-->
    <script src="//js.arcgis.com/3.11/"></script>
    <!-- website icon found in this website: https://www.pngegg.com/en/search?q=paper+Map#google_vignette -->
    <style>
        body { 
            margin: 0; /*no space around div*/
            padding: 0; /*no space inside div*/
            display: flex; /*flexbox for organizing the webiste*/
            flex-direction: column; /*column direction flex*/
            background-color: #FEF9F2; /*background color of the website*/
        }
        
        .navbar {
            background-color: #b6d898; /* Background color for navbar */
            overflow: hidden;
            display: flex; /* Use flexbox for layout */
            padding-left: 10px;
            align-items: center; /* Vertically center items */
            justify-content: space-between; /* align everythingt to the left*/
            padding: 10px 20px; /* Add padding for aesthetics */
            padding-right: 70px;
            font: 0.8rem "verdana", sans-serif; /* Font settings */
            gap: 20px; /* Add some space between the header and the buttons */
        }

        .navbar h1 {
            font-size: 1.2rem; /* Larger font for header */
            color: black; /* Text color for header */
            margin: 0; /* Remove default margin */
            margin-left: 20px;
        }

        .nav-links {
            list-style: none; /* Remove bullet points */
            margin: 0; /* Remove default margin */
            padding: 0; /* Remove default padding */
            display: flex; /* Use flexbox for horizontal layout */
            align-items: center; /* Vertically center the buttons */
            gap: 20px; /* Add space between buttons */
        }

        .nav-links li {
            padding-top: 0; /* Remove padding to vertically center in the nav bar */
        }

        .nav-links a {
            color: black; /* Link color */
            text-decoration: none; /* Remove underline */
            font-size: 0.8rem; /* Font size for links */
            padding: 10px 15px; /* Increase padding for bigger clickable area */
            background-color: #eaf4cf; /* Background color for links */
            /*border: 2px solid #4e5965; /* Border color and thickness for the frame */
            border-radius: 5px; /* Rounded corners */
            transition: background-color 0.3s ease; /* Smooth hover effect */
            display: inline-block; /* Ensure padding applies evenly around text */
            width: 120px;
            text-align: center;
        }

        .nav-links a:hover {
            background-color:  #ffffe9; /* Background color on hover */
        }

        /* New styles for responsiveness */
        
        

        #title {
            /*font: small-caps bold 1.8rem "verdana", sans-serif; /*set a font*/
            font: bold 1.7rem "verdana", sans-serif;
            text-align: center; /*center the title for aesthetics*/
            background-color: #f0eeb3; /*background color of title box*/
            padding: 20px; /*add padding and margin for aesthetics*/
            margin: 10px;
            border-radius: 10px;
        }

        
        #displayTree {
            display: grid;
            grid-template-columns: 30% 68%;
            column-gap: 15px;
            margin-left:10px;
        } 

        #text {
            grid-column: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding-left: 5%;
            padding-right: 5%;
            background: rgb(249, 187, 154);
            border-radius: 10px;
        }

        button {
            background:#f3d864;
            width: 150px;
            height: 30px;
            font: 0.8rem "verdana", sans-serif;
            border-radius: 7px;
            border-color: #f0e8aa;
            transition: background-color 0.3s ease;
            margin: 3px;
            margin-top: 8px;
        }
        button:hover {
            background-color:  #f9e5ba; /* Background color on hover */
        }

        #distTitle {
            font: bold 1rem "verdana", sans-serif;
            /*width: 500px; */
            justify-self: left;
            margin-top: 25px;
        }

        #treesAround {
            font: 0.8rem "verdana", sans-serif;
            line-height: 25px;
        }


        #map { 
            width: 100%; /*width of the map takes up 95% of the page*/
            height: 730px; /*set the height of the page to a reasonable value*/
            justify-self: center; /*center the map*/
            border-radius: 10px; /*make the border angle round*/
            position: relative; /*relative position to apply z-index*/
            z-index: 1; /*Move the map behind toggle bars*/
            grid-column: 2;
        } 

        @media (min-width:320px) and (max-width:650px){
        #title {
            /*font: small-caps bold 1.8rem "verdana", sans-serif; /*set a font*/
            font: bold 1.3rem "verdana", sans-serif;
            padding: 10px; /*add padding and margin for aesthetics*/
            margin: 7px;
        }
        #displayTree {
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin-left:10px;
        } 
        #text {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding-left: 2%;
            padding-right: 2%;
            margin-right: 2%;
            margin-bottom: 2%;
        }

        #map { 
            width: 95%; /*width of the map takes up 95% of the page*/
            height: 500px; /*set the height of the page to a reasonable value*/
            padding-left:3%;
        } 
        
    }

    </style>
</head>
<body>
    <nav class="navbar">
        <h1>McGill Tree Guide </h1>
        <ul class="nav-links">
            <li><a href="">Species List</a></li>
            <li><a href="">Soil Collection</a></li>
            <li><a href="">Historical Ecology</a></li>
        </ul>
    </nav>
    <h1 id="title">Tree Inventory Helper</h1>
    <div id="displayTree">
        <div id="text">
            <button id = "locationBtn" onclick = "getLocation()"> Get my location</button>
            <h1 id="distTitle">Trees within 10 meters to you</h1>
            <p id="treesAround"></p>
        </div>
        <div id="map"></div>
    </div>
    
<script>
    //document.getElementById("treesAround").innerHTML = "hello";

    mapboxgl.accessToken = 'pk.eyJ1Ijoic2x5dzAyNDYiLCJhIjoiY20wdjhvNGtvMWg1ZTJpcTVuc3E0NXp5YyJ9.WMIP4DPHgpFwrqKGTEf0FA';

    const map = new mapboxgl.Map({
        container: 'map', // container ID
        style: 'mapbox://styles/slyw0246/cm1l31w4s006z01pdetjp1gjt', // set style for the map mapbox://styles/mapbox/streets-v12 (older style)
        center: [-73.5782611, 45.5065694], // starting position [lng, lat]. Note that lat must be set between -90 and 90
        zoom: 14.9 // starting zoom
    }); 

    map.on('load', function() { 
        //the url (name) of the .json file - must be in same folder as the 
        //add a source 
        map.addSource('McgillTrees', { 
            type: 'geojson', 
            data: 'tree_mcgill_shp1.geojson'}); 
        // add map layer using 'ShirleyData' as source
        map.addLayer({ 
            id: "trees", // create id for later use in animation, toggle, and popup functions
            type: "circle", 
            source: "McgillTrees",
            layout: {
                // Make the layer visible by default.
                'visibility': 'visible'
            },
            // add color and width to the line
            paint: {
                'circle-radius': 5, // make the line more visible
                'circle-color': '#117a23', 
                //'line-opacity': 0.4 // opacity for dash line animation
            } // from mapbox website code about loading geojson in mapbox
        });}
        // add map layer for dash line animation
    )

    map.on('click', 'trees', (e) => {
        new mapboxgl.Popup() // call a built in function mapboxgl.Popup()
            .setLngLat(e.features[0].geometry.coordinates.slice()) // get the coordinate of e
            .setHTML(e.features[0].properties.nomsc + " (" + e.features[0].properties.nomanglais + ")") // set the HTML of the popup as the description in geoJSON of the layer
            .addTo(map); // add the popup to map
    });

    map.on('mouseenter', 'trees', () => {
        map.getCanvas().style.cursor = 'pointer'; // built in function to change the cursor to a pointer
    });

    // Change it back to a normal curosr when it leaves the feature
    map.on('mouseleave', 'trees', () => {
        map.getCanvas().style.cursor = ''; // built in function to change the cursor back to normal
    });

    map.addControl(
        new mapboxgl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            // When active the map will receive updates to the device's location as it changes.
            trackUserLocation: true,
            // Draw an arrow next to the location dot to indicate which direction the device is heading.
            showUserHeading: true
        })
    );

    //var firstProj = "+proj=longlat +datum=WGS84 +no_defs";
    // https://community.esri.com/t5/developers-blog/use-proj4js-alongside-the-arcgis-api-for/ba-p/892054
    var toProj = "+proj=utm +zone=18 +datum=WGS84 +units=m +no_defs";
    //var tryProj = 'PROJCS["NAD83 / Massachusetts Mainland",GEOGCS["NAD83",DATUM["North_American_Datum_1983",SPHEROID["GRS 1980",6378137,298.257222101,AUTHORITY["EPSG","7019"]],AUTHORITY["EPSG","6269"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.01745329251994328,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4269"]],UNIT["metre",1,AUTHORITY["EPSG","9001"]],PROJECTION["Lambert_Conformal_Conic_2SP"],PARAMETER["standard_parallel_1",42.68333333333333],PARAMETER["standard_parallel_2",41.71666666666667],PARAMETER["latitude_of_origin",41],PARAMETER["central_meridian",-71.5],PARAMETER["false_easting",200000],PARAMETER["false_northing",750000],AUTHORITY["EPSG","26986"],AXIS["X",EAST],AXIS["Y",NORTH]]';
    var reprojectedCoords = proj4(toProj, [-73.583085206269843, 45.510551749860447]);
    console.log(reprojectedCoords);

    // loop through all points, if the point is within 5 meters of the location, add nomsc to the innerHTML

    //var allTreePts = {}; // create an object for all trees containing the coordinates and species name
    //var allCoords = [];

    let tryJson;
    let allJsonPts = { // crreate a geojson feature
        "type": "FeatureCollection",
        "features": []
    };
    fetch("tree_mcgill_shp1_Copy.geojson")
        .then(response => response.json())
        .then(data => {
            tryJson = data;
            console.log("This are tree points Json features", tryJson.features);
        
            for (i=0; i<tryJson.features.length; i++) { // 1618 is the feature length
                tryJson.features[i].properties.lat= tryJson.features[i].geometry.coordinates[1];
                tryJson.features[i].properties.lon= tryJson.features[i].geometry.coordinates[0];
                tryJson.features[i].properties.sceng = tryJson.features[i].properties.nomsc + " (" + tryJson.features[i].properties.nomanglais + ")";
                }
                
            console.log("This are tree points Json", tryJson)
            //allTreePts.species = 

            for (i=0; i<tryJson.features.length; i++) {
                allJsonPts.features.push(tryJson.features[i]);
            }



    /*
    function convertDegToM(lat1, lat2, lon1, lon2) { // from stackoverflow
        //https://stackoverflow.com/questions/4102520/how-to-transform-a-distance-from-degrees-to-metres 
        var R = 6371;
        if (typeof(Number.prototype.toRad) === "undefined") {
            Number.prototype.toRad = function () {
                return this * Math.PI / 180;
            }
        }
        var dLat = (lat2 - lat1).toRad();
        var dLon = (lon2 - lon1).toRad();
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1.toRad()) * Math.cos(lat2.toRad()) * 
            Math.sin(dLon/2) * Math.sin(dLon/2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        var d = R*c;
        return d;
    }*/


    //var utmOnj = require('utm-latlng');
    //https://www.pythontutorials.net/blog/how-to-convert-from-utm-to-latlng-in-python-or-javascript/

    


    //utm.convertLatLngToUtm(44.062027, 143.5279742, 1)

    // console.log(utm.convertLatLngToUtm(44.062027, 143.5279742, 1));

    //console.log("the distance is:", tryDist);





    }) // end of fetch

    console.log("these are extracted points", allJsonPts)

    let ptsWithin5m = { // crreate a geojson feature
        "type": "FeatureCollection",
        "features": []
    };
    
    let speciesWithin5m = [];
    function within5m(userCoords) { // input a list of two elements (lon and lat)
        var userUTM = proj4(toProj, userCoords);
        for (i=0; i<allJsonPts.features.length; i++) {
            var pointUTM = proj4(toProj, allJsonPts.features[i].geometry.coordinates);
            let dist = Math.sqrt((pointUTM[0]-userUTM[0])**2 + (pointUTM[1]-userUTM[1])**2);
            if (i==5) {console.log("see distance", dist)};
            if (dist <= 50) {
                ptsWithin5m.features.push(allJsonPts.features[i]); // feature to geojson
                speciesWithin5m.push(allJsonPts.features[i].properties.sceng); // species to list
                //console.log(allJsonPts.features[i])
            }
        }  
        console.log(ptsWithin5m);
        return speciesWithin5m;
    }
        
    //let myCoords = [-73.5807137, 45.5113170];
    // get user coordinates

    // add event listener for button click
    var x = document.getElementById("locationBtn");
    x.addEventListener("click", getTrees(myCoord))

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        } else { 
            x.innerHTML = "Geolocation is not supported by this browser.";
        }
    }
    var myCoord = [];
    var treesNearMe;
    var treeNum = 0;
    var treeToHTML = "";
    function showPosition(position) { // not run before button click
        myCoord.push(position.coords.longitude);
        myCoord.push(position.coords.latitude);
        alert("you location is latitude: " + myCoord[1] + ", longitude: " + myCoord[0])
        console.log("this is my coordinate", myCoord);

        treesNearMe = within5m(myCoord);
        console.log("these trees are near me: ", treesNearMe);
        console.log("this is my coordinate", myCoord);
        for (i=0; i<treesNearMe.length; i++) {
            if (!treeToHTML.includes(treesNearMe[i])) {
                treeToHTML += "<br>" + treesNearMe[i];
                treeNum += 1};
        }
        console.log("number of tree species:", treeNum);
        if (treesNearMe.length==0) {
            document.getElementById("treesAround").innerHTML = "There is no tree near you";
        } else(
            document.getElementById("treesAround").innerHTML = "There are " + treeNum + " tree species near you. They are: " + treeToHTML);
    }

    document.getElementById("treesAround").innerHTML = "Click on the \"Get my location\" button to see the tree species near you.";
    

    //var treesNearMe;
    //var treeToHTML = "The tree speceis around you are:";
    function getTrees(coords) {
        treesNearMe = within5m(coords);
        console.log("these trees are near me", treesNearMe);
        console.log("this is my coordinate", coords);
        for (i=0; i<treesNearMe.length; i++) {
            if (!treeToHTML.includes(treesNearMe[i])) {
                treeToHTML += treesNearMe[i] + ", "};
        }
        document.getElementById("treesAround").innerHTML = treeToHTML;

    }
    console.log("this is my coordinate", myCoord);
    //ptsNearMe = within5m(myCoord);
    //console.log("these trees are near me", ptsNearMe)
    //console.log("this is my coordinate", myCoord)


    /*
    for (i=0; i<ptsNearMe.length; i++) {
        if (!treeToHTML.includes(ptsNearMe[i])) {
            treeToHTML += ptsNearMe[i] + ", "};
    }
    document.getElementById("treesAround").innerHTML = treeToHTML;*/



        
    // try calculate distance
    var tryUTM1 = proj4(toProj, [-73.5770057, 45.5030949]);
    var tryUTM2 = proj4(toProj, [-73.5761314, 45.5039374]);
    console.log(tryUTM1);
    console.log(tryUTM2);
    console.log((tryUTM1[0]-tryUTM2[0])**2);
    console.log(tryUTM1[1]-tryUTM2[1]);
    console.log(Math.sqrt((tryUTM1[0]-tryUTM2[0])**2 + (tryUTM1[1]-tryUTM2[1])**2));


    /*
    let ptsWithin5m = { // crreate a geojson feature
        "type": "FeatureCollection",
        "features": []
    };

    function within5m(userCoords) { // input a list of two elements (lon and lat)
        for (i=0; i<tryJson.features.length; i++) {
            let dist = sqrt((tryJson.features[i].geometry.coordinates[0]-userCoords[0])^2 +
                    (tryJson.features[i].geometry.coordinates[1]-userCoords[1])^2);
            if (dist <= 5) {
                ptsWithin5m.features.push(tryJsonfeature[i])
            }
        }  
    }*/

    //tryJson.features.properties.lat = tryJson.features.geometry.coordinates;
    //console.log(tryJson.features.properties.lat)
    //console.log("hello")


</script>
</body>